{% extends "base.html" %}

{% block title %}Admin Dashboard - Personal Finance Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    /* Inline critical styles for immediate rendering */
    .admin-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    .admin-header {
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
        color: var(--text-primary);
    }
    .stats-cards {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    .stat-card {
        flex: 1;
        min-width: 200px;
        padding: 20px;
        background: var(--bg-tertiary) !important;
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 10px;
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
    }
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: -50px;
        width: 100px;
        height: 100%;
        background: rgba(255,255,255,0.03);
        transform: skewX(-25deg);
    }
    .stat-card h3 {
        margin: 0;
        font-size: 2rem;
        font-weight: bold;
        color: var(--text-primary);
    }
    .stat-card p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        color: var(--text-secondary);
    }
    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: var(--card-shadow);
        margin-bottom: 30px;
        overflow: hidden;
    }
    .section-header {
        padding: 20px;
        background: var(--card-header-bg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        color: var(--text-primary);
    }
    .section-body {
        padding: 20px;
    }
    .error-banner {
        background: #f8d7da;
        color: #721c24;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
    }
    .user-table, .audit-table {
        width: 100%;
        border-collapse: collapse;
        color: var(--text-primary);
    }
    .user-table th, .audit-table th {
        background: var(--card-bg);
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
        color: var(--text-primary);
    }
    .user-table td, .audit-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
    }
    .user-table tbody tr, .audit-table tbody tr {
        background: var(--table-bg);
    }
    .user-table tbody tr:hover, .audit-table tbody tr:hover {
        background: var(--table-hover);
    }
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .badge-success {
        background: #28a745;
        color: white;
    }
    .badge-danger {
        background: #dc3545;
        color: white;
    }
    .badge-primary {
        background: #007bff;
        color: white;
    }
    .badge-secondary {
        background: #6c757d;
        color: white;
    }
    .badge-info {
        background: #17a2b8;
        color: white;
    }
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    .btn-sm {
        padding: 5px 10px;
        font-size: 0.875rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-sm:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    .btn-success {
        background: #28a745;
        color: white;
    }
    .btn-primary {
        background: #007bff;
        color: white;
    }
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    .search-box {
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 0.95rem;
        min-width: 250px;
    }
    [data-theme="dark"] .search-box {
        background: #1a1a1a;
        border-color: #444;
        color: white;
    }
    .text-muted {
        color: #6c757d;
        font-style: italic;
    }

    /* CRITICAL: Fix for overlay/layer blocking clicks */
    .admin-container {
        position: relative;
        z-index: 1;
        pointer-events: auto;
    }

    /* Ensure buttons are clickable */
    button, .btn, .btn-sm {
        position: relative;
        z-index: 2;
        pointer-events: auto;
    }

    /* Ensure modals appear above everything */
    .modal {
        z-index: 10000 !important;
    }

    .modal-backdrop {
        z-index: 9999 !important;
    }

    /* Ensure tables don't block buttons */
    .user-table, .audit-table {
        position: relative;
        z-index: 1;
    }

    .action-buttons {
        position: relative;
        z-index: 3;
    }

    /* Fix for navbar not overlapping */
    .navbar {
        z-index: 100;
    }

    /* Ensure no pseudo-elements block content */
    body::before,
    body::after,
    .admin-container::before,
    .admin-container::after {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<script>
    // Add admin-page class to body for specific styling
    document.body.classList.add('admin-page');
</script>
<div class="admin-container">
    <!-- Header -->
    <div class="admin-header">
        <h1 style="margin: 0; color: var(--text-primary);">
            <i class="fas fa-user-shield"></i> Admin Dashboard
        </h1>
        <p style="margin: 5px 0 0 0; color: var(--text-secondary);">
            Manage users, permissions, and view system audit logs
        </p>
    </div>

    {% if error_message %}
    <div class="error-banner">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Error:</strong> {{ error_message }}
    </div>
    {% endif %}

    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <h3>{{ users|length }}</h3>
            <p><i class="fas fa-users"></i> Total Users</p>
        </div>
        <div class="stat-card">
            <h3>{{ users|selectattr('is_active')|list|length }}</h3>
            <p><i class="fas fa-user-check"></i> Active Users</p>
        </div>
        <div class="stat-card">
            <h3>{{ users|selectattr('is_admin')|list|length }}</h3>
            <p><i class="fas fa-shield-alt"></i> Administrators</p>
        </div>
        <div class="stat-card">
            <h3>{{ audit_logs|length }}</h3>
            <p><i class="fas fa-history"></i> Recent Actions</p>
        </div>
    </div>

    <!-- System Settings Section -->
    <div class="section-card">
        <div class="section-header">
            <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">
                <i class="fas fa-cog"></i> System Settings
            </h2>
        </div>
        <div class="section-body">
            <!-- Refresh-mode radio toggle -->
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <label style="color: var(--text-primary); font-weight: 600; min-width: 300px;">
                    <i class="fas fa-sync-alt"></i> Exchange Rate Refresh Mode
                </label>
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-primary);">
                        <input type="radio" name="refreshMode" id="modeBackground" value="background"
                               {% if settings.get('exchange_rate_refresh_mode', {}).get('value', 'background') == 'background' %}checked{% endif %}
                               oninput="onModeChange()">
                        <span>Background (automatic)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-primary);">
                        <input type="radio" name="refreshMode" id="modeManual" value="manual"
                               {% if settings.get('exchange_rate_refresh_mode', {}).get('value', 'background') == 'manual' %}checked{% endif %}
                               oninput="onModeChange()">
                        <span>Manual</span>
                    </label>
                    <button class="btn-sm btn-primary" id="saveModeBtn" onclick="saveRefreshMode()" disabled>
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>
            <p style="color: var(--text-secondary); margin-top: 8px; font-size: 0.9rem;">
                {{ settings.get('exchange_rate_refresh_mode', {}).get('description', '') }}
            </p>

            <!-- Refresh interval (visible only when mode = background) -->
            <div id="intervalRow"
                 style="display: {% if settings.get('exchange_rate_refresh_mode', {}).get('value', 'background') == 'background' %}flex{% else %}none{% endif %}; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 18px;">
                <label style="color: var(--text-primary); font-weight: 600; min-width: 300px;">
                    <i class="fas fa-clock"></i> Refresh Interval
                </label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="number"
                           id="refreshIntervalInput"
                           value="{{ settings.get('exchange_rate_refresh_interval_minutes', {}).get('value', '60') }}"
                           min="1"
                           style="width: 80px; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;"
                           oninput="markIntervalDirty()">
                    <span style="color: var(--text-secondary); font-weight: 500;">minutes</span>
                    <button class="btn-sm btn-primary" id="saveIntervalBtn" onclick="saveRefreshInterval()" disabled>
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>
            <p id="intervalDesc"
               style="color: var(--text-secondary); margin-top: 8px; font-size: 0.9rem; display: {% if settings.get('exchange_rate_refresh_mode', {}).get('value', 'background') == 'background' %}block{% else %}none{% endif %};">
                {{ settings.get('exchange_rate_refresh_interval_minutes', {}).get('description', '') }}
                <em>— change takes effect after the next scheduled run, no restart needed.</em>
            </p>

            <!-- Manual "Refresh All" button (always visible) -->
            <div style="margin-top: 18px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <button class="btn-sm btn-primary" id="refreshAllBtn" onclick="refreshAllRates()">
                    <i class="fas fa-sync-alt"></i> Refresh All Rates Now
                </button>
                <span style="color: var(--text-secondary); font-size: 0.9rem;">
                    Fetch fresh rates from HNB, People's Bank, and CBSL on demand.
                </span>
            </div>
        </div>
    </div>

    <!-- User Management Section -->
    <div class="section-card">
        <div class="section-header">
            <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">
                <i class="fas fa-users"></i> User Management
            </h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text"
                       id="userSearch"
                       class="search-box"
                       placeholder="Search by username, email, or ID..."
                       onkeyup="filterUsers()">
                <button class="btn-sm btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="section-body" style="overflow-x: auto;">
            {% if users %}
            <table class="user-table" id="userTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Role</th>
                        <th>Last Login</th>
                        <th>Created</th>
                        <th>Records</th>
                        <th>Transactions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    {% for user in users %}
                    <tr class="user-row" data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-email="{{ user.email }}">
                        <td>{{ user.id }}</td>
                        <td><strong>{{ user.username }}</strong></td>
                        <td>{{ user.email }}</td>
                        <td>
                            {% if user.is_active %}
                            <span class="badge badge-success">Active</span>
                            {% else %}
                            <span class="badge badge-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_admin %}
                            <span class="badge badge-primary">Admin</span>
                            {% else %}
                            <span class="badge badge-secondary">User</span>
                            {% endif %}
                        </td>
                        <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                        <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'N/A' }}</td>
                        <td>{{ user.monthly_records_count or 0 }}</td>
                        <td>{{ user.transactions_count or 0 }}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm {{ 'btn-warning' if user.is_active else 'btn-success' }}"
                                        onclick="toggleUserActive({{ user.id }}, '{{ user.username }}')"
                                        title="{{ 'Deactivate' if user.is_active else 'Activate' }} user"
                                        {% if user.id == current_user_id %}disabled{% endif %}>
                                    <i class="fas fa-{{ 'ban' if user.is_active else 'check' }}"></i>
                                </button>
                                <button class="btn-sm {{ 'btn-secondary' if user.is_admin else 'btn-primary' }}"
                                        onclick="toggleUserAdmin({{ user.id }}, '{{ user.username }}')"
                                        title="{{ 'Revoke' if user.is_admin else 'Grant' }} admin"
                                        {% if user.id == current_user_id %}disabled{% endif %}>
                                    <i class="fas fa-user-shield"></i>
                                </button>
                                <button class="btn-sm btn-danger"
                                        onclick="showDeleteModal({{ user.id }}, '{{ user.username }}')"
                                        title="Delete user"
                                        {% if user.id == current_user_id %}disabled{% endif %}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted" style="text-align: center; padding: 40px;">No users found in the database.</p>
            {% endif %}
        </div>
    </div>

    <!-- Audit Logs Section -->
    <div class="section-card">
        <div class="section-header">
            <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">
                <i class="fas fa-history"></i> Audit Logs
                <span class="badge badge-secondary" style="font-size: 0.75rem; margin-left: 10px;">Last 50</span>
            </h2>
            <button class="btn-sm btn-primary" onclick="refreshAuditLogs()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div class="section-body" style="overflow-x: auto;">
            {% if audit_logs %}
            <table class="audit-table" id="auditTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Admin</th>
                        <th>Action</th>
                        <th>Target User</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in audit_logs %}
                    <tr>
                        <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') if log.created_at else 'N/A' }}</td>
                        <td><strong>{{ log.admin_username }}</strong></td>
                        <td><span class="badge badge-info">{{ log.action }}</span></td>
                        <td>{{ log.target_username or 'N/A' }}</td>
                        <td>{{ log.details or '' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted" style="text-align: center; padding: 40px;">No audit logs available.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color, #dee2e6);">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger"></i> Confirm Delete User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete user <strong id="deleteUsername"></strong>?</p>
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Warning:</strong> This action cannot be undone. All user data including transactions and records will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color, #dee2e6);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> Delete User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Alert Toast -->
<div id="alertToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: none; min-width: 300px;">
    <div class="alert alert-dismissible fade show" role="alert" id="alertContent" style="box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <span id="alertMessage"></span>
        <button type="button" class="btn-close" onclick="hideAlert()"></button>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    console.log('Admin Dashboard JavaScript Loaded');
    console.log('Users loaded:', {{ users|length }});
    console.log('Audit logs loaded:', {{ audit_logs|length }});

    let currentDeleteUserId = null;
    let deleteModal = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded');
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        // CRITICAL FIX: Remove any lingering modal backdrops or overlays
        clearModalBackdrops();

        // Remove any bootstrap modal-open class that might block scrolling
        document.body.classList.remove('modal-open');

        // Remove inline styles that might block interaction
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';

        console.log('Admin page initialized and cleared of overlays');
    });

    // Function to clear all modal backdrops and overlays
    function clearModalBackdrops() {
        // Remove all modal backdrops
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            console.log('Removing modal backdrop');
            backdrop.remove();
        });

        // Ensure body doesn't have modal-open class
        document.body.classList.remove('modal-open');

        // Reset body overflow
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }

    // Clear backdrops when modal is hidden
    document.getElementById('deleteModal').addEventListener('hidden.bs.modal', function() {
        setTimeout(clearModalBackdrops, 100);
    });

    // Filter users based on search input
    function filterUsers() {
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        const rows = document.querySelectorAll('.user-row');

        rows.forEach(row => {
            const userId = row.getAttribute('data-user-id');
            const username = row.getAttribute('data-username').toLowerCase();
            const email = row.getAttribute('data-email').toLowerCase();

            if (userId.includes(searchTerm) || username.includes(searchTerm) || email.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Show alert message
    function showAlert(message, type = 'success') {
        const alertToast = document.getElementById('alertToast');
        const alertContent = document.getElementById('alertContent');
        const alertMessage = document.getElementById('alertMessage');

        alertContent.className = `alert alert-${type} alert-dismissible fade show`;
        alertMessage.textContent = message;
        alertToast.style.display = 'block';

        setTimeout(() => {
            hideAlert();
        }, 5000);
    }

    // Hide alert
    function hideAlert() {
        document.getElementById('alertToast').style.display = 'none';
    }

    // Toggle user active status
    async function toggleUserActive(userId, username) {
        if (!confirm(`Are you sure you want to toggle ${username}'s account status?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/users/${userId}/toggle-active`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to update user', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
        }
    }

    // Toggle user admin status
    async function toggleUserAdmin(userId, username) {
        if (!confirm(`Are you sure you want to modify ${username}'s admin privileges?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/users/${userId}/toggle-admin`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to update user', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
        }
    }

    // Show delete confirmation modal
    function showDeleteModal(userId, username) {
        currentDeleteUserId = userId;
        document.getElementById('deleteUsername').textContent = username;
        deleteModal.show();
    }

    // Confirm and execute delete
    async function confirmDelete() {
        if (!currentDeleteUserId) return;

        const deleteBtn = document.getElementById('confirmDeleteBtn');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        try {
            const response = await fetch(`/api/admin/users/${currentDeleteUserId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                deleteModal.hide();
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to delete user', 'danger');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalText;
        }
    }

    // Refresh all data
    function refreshData() {
        showAlert('Refreshing data...', 'info');
        setTimeout(() => location.reload(), 500);
    }

    // Refresh audit logs
    function refreshAuditLogs() {
        showAlert('Refreshing audit logs...', 'info');
        setTimeout(() => location.reload(), 500);
    }

    // Debug helper: Log if any element is blocking clicks
    window.addEventListener('click', function(e) {
        const target = e.target;
        const computedStyle = window.getComputedStyle(target);
        if (computedStyle.pointerEvents === 'none') {
            console.warn('Click blocked on element:', target, 'pointer-events:', computedStyle.pointerEvents);
        }
    });

    // Periodic check to remove any rouge overlays (safety net)
    setInterval(function() {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0 && !document.querySelector('.modal.show')) {
            console.log('Found rouge modal backdrop, removing...');
            clearModalBackdrops();
        }
    }, 2000);

    console.log('Admin Dashboard fully initialized - All overlays cleared');

    // ── System Settings: refresh mode ───────────────────────────
    const _modeOriginal = document.querySelector('input[name="refreshMode"]:checked').value;

    function onModeChange() {
        const current = document.querySelector('input[name="refreshMode"]:checked').value;
        document.getElementById('saveModeBtn').disabled = (current === _modeOriginal);
        const isBackground = (current === 'background');
        document.getElementById('intervalRow').style.display  = isBackground ? 'flex'  : 'none';
        document.getElementById('intervalDesc').style.display = isBackground ? 'block' : 'none';
    }

    async function saveRefreshMode() {
        const value = document.querySelector('input[name="refreshMode"]:checked').value;
        const btn   = document.getElementById('saveModeBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving\u2026';

        try {
            const response = await fetch('/api/admin/settings/exchange_rate_refresh_mode', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: value })
            });
            const data = await response.json();
            if (response.ok) {
                showAlert('Refresh mode set to \u201c' + value + '\u201d', 'success');
                btn.innerHTML = '<i class="fas fa-save"></i> Save';
                // keep disabled — value now matches server
            } else {
                showAlert(data.error || 'Failed to update setting', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save';
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Save';
        }
    }

    // ── System Settings: on-demand refresh ───────────────────────
    async function refreshAllRates() {
        const btn = document.getElementById('refreshAllBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing\u2026';

        try {
            const response = await fetch('/api/exchange-rate/refresh-all');
            const data = await response.json();
            if (response.ok) {
                showAlert('All exchange rates refreshed successfully', 'success');
            } else {
                showAlert(data.error || 'Refresh failed', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh All Rates Now';
    }

    // ── System Settings: refresh interval ──────────────────────
    // Save button stays disabled until the value actually changes
    const _intervalOriginal = document.getElementById('refreshIntervalInput').value;

    function markIntervalDirty() {
        const current = document.getElementById('refreshIntervalInput').value;
        document.getElementById('saveIntervalBtn').disabled = (current === _intervalOriginal);
    }

    async function saveRefreshInterval() {
        const input = document.getElementById('refreshIntervalInput');
        const value = input.value.trim();

        if (!value || parseInt(value) < 1) {
            showAlert('Interval must be at least 1 minute', 'danger');
            return;
        }

        const btn = document.getElementById('saveIntervalBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving…';

        try {
            const response = await fetch('/api/admin/settings/exchange_rate_refresh_interval_minutes', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: value })
            });

            const data = await response.json();

            if (response.ok) {
                showAlert('Refresh interval updated to ' + value + ' minutes', 'success');
                btn.innerHTML = '<i class="fas fa-save"></i> Save';
                // keep button disabled — value now matches what the server has
            } else {
                showAlert(data.error || 'Failed to update setting', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save';
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Save';
        }
    }
</script>
{% endblock %}
