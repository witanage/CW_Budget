{% extends "base.html" %}

{% block title %}Admin Dashboard - Personal Finance Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    /* Inline critical styles for immediate rendering */
    .admin-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    .admin-header {
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
        color: var(--text-primary);
    }
    .stats-cards {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    .stat-card {
        flex: 1;
        min-width: 200px;
        padding: 20px;
        background: var(--bg-tertiary) !important;
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 10px;
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
    }
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: -50px;
        width: 100px;
        height: 100%;
        background: rgba(255,255,255,0.03);
        transform: skewX(-25deg);
    }
    .stat-card h3 {
        margin: 0;
        font-size: 2rem;
        font-weight: bold;
        color: var(--text-primary);
    }
    .stat-card p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        color: var(--text-secondary);
    }
    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: var(--card-shadow);
        margin-bottom: 30px;
        overflow: hidden;
    }
    .section-header {
        padding: 20px;
        background: var(--card-header-bg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        color: var(--text-primary);
    }
    .section-body {
        padding: 20px;
    }
    .error-banner {
        background: #f8d7da;
        color: #721c24;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
    }
    .user-table, .audit-table {
        width: 100%;
        border-collapse: collapse;
        color: var(--text-primary);
    }
    .user-table th, .audit-table th {
        background: var(--card-bg);
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
        color: var(--text-primary);
    }
    .user-table td, .audit-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
    }
    .user-table tbody tr, .audit-table tbody tr {
        background: var(--table-bg);
    }
    .user-table tbody tr:hover, .audit-table tbody tr:hover {
        background: var(--table-hover);
    }
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .badge-success {
        background: #28a745;
        color: white;
    }
    .badge-danger {
        background: #dc3545;
        color: white;
    }
    .badge-primary {
        background: #007bff;
        color: white;
    }
    .badge-secondary {
        background: #6c757d;
        color: white;
    }
    .badge-info {
        background: #17a2b8;
        color: white;
    }
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    .btn-sm {
        padding: 5px 10px;
        font-size: 0.875rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-sm:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    .btn-success {
        background: #28a745;
        color: white;
    }
    .btn-primary {
        background: #007bff;
        color: white;
    }
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    .search-box {
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 0.95rem;
        min-width: 250px;
    }
    [data-theme="dark"] .search-box {
        background: #1a1a1a;
        border-color: #444;
        color: white;
    }
    .text-muted {
        color: #6c757d;
        font-style: italic;
    }

    /* Admin Tabs */
    .admin-tabs {
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 0;
        gap: 4px;
        flex-wrap: wrap;
    }
    .admin-tabs .nav-link {
        border: 1px solid transparent;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        padding: 12px 20px;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.95rem;
        background: transparent;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .admin-tabs .nav-link:hover {
        color: var(--text-primary);
        background: var(--bg-tertiary);
        border-color: var(--border-color) var(--border-color) transparent;
    }
    .admin-tabs .nav-link.active {
        color: #007bff;
        background: var(--card-bg);
        border-color: var(--border-color) var(--border-color) var(--card-bg);
        font-weight: 600;
        margin-bottom: -2px;
    }
    .admin-tabs .nav-link i {
        font-size: 0.9rem;
    }
    .admin-tab-content {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 10px 10px;
        padding: 0;
        min-height: 300px;
    }
    .admin-tab-content .section-card {
        margin-bottom: 0;
        border: none;
        border-radius: 0 0 10px 10px;
        box-shadow: none;
    }
    .admin-tab-content .section-card .section-header {
        border-radius: 0;
    }

    /* CRITICAL: Fix for overlay/layer blocking clicks */
    .admin-container {
        position: relative;
        z-index: 1;
        pointer-events: auto;
    }

    /* Ensure buttons are clickable */
    button, .btn, .btn-sm {
        position: relative;
        z-index: 2;
        pointer-events: auto;
    }

    /* Ensure modals appear above everything */
    .modal {
        z-index: 10000 !important;
    }

    .modal-backdrop {
        z-index: 9999 !important;
    }

    /* Ensure tables don't block buttons */
    .user-table, .audit-table {
        position: relative;
        z-index: 1;
    }

    .action-buttons {
        position: relative;
        z-index: 3;
    }

    /* Fix for navbar not overlapping */
    .navbar {
        z-index: 100;
    }

    /* Ensure no pseudo-elements block content */
    body::before,
    body::after,
    .admin-container::before,
    .admin-container::after {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<script>
    // Add admin-page class to body for specific styling
    document.body.classList.add('admin-page');
</script>
<div class="admin-container">
    <!-- Header -->
    <div class="admin-header">
        <h1 style="margin: 0; color: var(--text-primary);">
            <i class="fas fa-user-shield"></i> Admin Dashboard
        </h1>
        <p style="margin: 5px 0 0 0; color: var(--text-secondary);">
            Manage users, permissions, and view system audit logs
        </p>
    </div>

    {% if error_message %}
    <div class="error-banner">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Error:</strong> {{ error_message }}
    </div>
    {% endif %}

    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <h3>{{ users|length }}</h3>
            <p><i class="fas fa-users"></i> Total Users</p>
        </div>
        <div class="stat-card">
            <h3>{{ users|selectattr('is_active')|list|length }}</h3>
            <p><i class="fas fa-user-check"></i> Active Users</p>
        </div>
        <div class="stat-card">
            <h3>{{ users|selectattr('is_admin')|list|length }}</h3>
            <p><i class="fas fa-shield-alt"></i> Administrators</p>
        </div>
        <div class="stat-card">
            <h3>{{ audit_logs|length }}</h3>
            <p><i class="fas fa-history"></i> Recent Actions</p>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs admin-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane"
                    type="button" role="tab" aria-controls="settings-pane" aria-selected="true">
                <i class="fas fa-cog"></i> <span class="tab-label">Settings</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv-pane"
                    type="button" role="tab" aria-controls="csv-pane" aria-selected="false">
                <i class="fas fa-file-csv"></i> <span class="tab-label">CSV Import</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records-pane"
                    type="button" role="tab" aria-controls="records-pane" aria-selected="false">
                <i class="fas fa-calendar-times"></i> <span class="tab-label">Delete Records</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane"
                    type="button" role="tab" aria-controls="users-pane" aria-selected="false">
                <i class="fas fa-users"></i> <span class="tab-label">Users</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit-pane"
                    type="button" role="tab" aria-controls="audit-pane" aria-selected="false">
                <i class="fas fa-history"></i> <span class="tab-label">Audit Logs</span>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content admin-tab-content" id="adminTabContent">

        <!-- System Settings Tab -->
        <div class="tab-pane fade show active" id="settings-pane" role="tabpanel" aria-labelledby="settings-tab">
            <div class="section-card">
                <div class="section-header">
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">
                        <i class="fas fa-cog"></i> System Settings
                    </h2>
                </div>
                <div class="section-body">
                    <!-- Refresh-mode radio toggle -->
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <label style="color: var(--text-primary); font-weight: 600; min-width: 300px;">
                            <i class="fas fa-sync-alt"></i> Exchange Rate Refresh Mode
                        </label>
                        <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-primary);">
                                <input type="radio" name="refreshMode" id="modeBackground" value="background"
                                       {% if settings.get('exchange_rate_refresh_mode', {}).get('value', 'background') == 'background' %}checked{% endif %}
                                       oninput="onModeChange()">
                                <span>Background (automatic)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-primary);">
                                <input type="radio" name="refreshMode" id="modeManual" value="manual"
                                       {% if settings.get('exchange_rate_refresh_mode', {}).get('value', 'background') == 'manual' %}checked{% endif %}
                                       oninput="onModeChange()">
                                <span>Manual</span>
                            </label>
                            <button class="btn-sm btn-primary" id="saveModeBtn" onclick="saveRefreshMode()" disabled>
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-top: 8px; font-size: 0.9rem;">
                        {{ settings.get('exchange_rate_refresh_mode', {}).get('description', '') }}
                    </p>

                    <!-- Refresh interval (visible only when mode = background) -->
                    <div id="intervalRow"
                         style="display: {% if settings.get('exchange_rate_refresh_mode', {}).get('value', 'background') == 'background' %}flex{% else %}none{% endif %}; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 18px;">
                        <label style="color: var(--text-primary); font-weight: 600; min-width: 300px;">
                            <i class="fas fa-clock"></i> Refresh Interval
                        </label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number"
                                   id="refreshIntervalInput"
                                   value="{{ settings.get('exchange_rate_refresh_interval_minutes', {}).get('value', '60') }}"
                                   min="1"
                                   style="width: 80px; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;"
                                   oninput="markIntervalDirty()">
                            <span style="color: var(--text-secondary); font-weight: 500;">minutes</span>
                            <button class="btn-sm btn-primary" id="saveIntervalBtn" onclick="saveRefreshInterval()" disabled>
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </div>
                    <p id="intervalDesc"
                       style="color: var(--text-secondary); margin-top: 8px; font-size: 0.9rem; display: {% if settings.get('exchange_rate_refresh_mode', {}).get('value', 'background') == 'background' %}block{% else %}none{% endif %};">
                        {{ settings.get('exchange_rate_refresh_interval_minutes', {}).get('description', '') }}
                        <em>— change takes effect after the next scheduled run, no restart needed.</em>
                    </p>

                    <!-- Manual "Refresh All" button (always visible) -->
                    <div style="margin-top: 18px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <button class="btn-sm btn-primary" id="refreshAllBtn" onclick="refreshAllRates()">
                            <i class="fas fa-sync-alt"></i> Refresh All Rates Now
                        </button>
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">
                            Fetch fresh rates from HNB, People's Bank, and CBSL on demand.
                        </span>
                    </div>
                </div>
            </div>

            <!-- Database Backup Section -->
            <div class="section-card">
                <div class="section-header">
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">
                        <i class="fas fa-database"></i> Database Backup
                    </h2>
                </div>
                <div class="section-body">
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        Download a complete SQL backup of the entire database. The backup includes all tables,
                        data, views, stored procedures, functions, triggers, and events in MySQL Workbench
                        compatible format (<code>.sql</code>).
                    </p>
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <button class="btn-sm btn-primary" id="dbBackupBtn" onclick="downloadDbBackup()" style="padding: 8px 20px; font-size: 0.95rem;">
                            <i class="fas fa-download"></i> Download Full Backup
                        </button>
                        <span id="dbBackupStatus" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CSV Import Tab -->
        <div class="tab-pane fade" id="csv-pane" role="tabpanel" aria-labelledby="csv-tab">
            <div class="section-card">
                <div class="section-header">
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">
                        <i class="fas fa-file-csv"></i> Import Transactions from CSV
                    </h2>
                </div>
                <div class="section-body">
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        Upload a CSV file with columns: <strong>Description, Credit, Debit, Note, Method</strong>.
                        Amounts may include currency prefixes (e.g. Rs) and thousand-separators.
                    </p>

                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px;">
                        <!-- User selector -->
                        <div style="flex: 1; min-width: 180px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                                <i class="fas fa-user"></i> User
                            </label>
                            <select id="csvUserId"
                                    style="width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem;">
                                <option value="">-- Select User --</option>
                                {% for user in users %}
                                {% if user.is_active %}
                                <option value="{{ user.id }}">{{ user.username }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Year -->
                        <div style="min-width: 110px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                                <i class="fas fa-calendar"></i> Year
                            </label>
                            <input type="number" id="csvYear" min="2000" max="2099"
                                   style="width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem;">
                        </div>

                        <!-- Month -->
                        <div style="min-width: 150px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                                <i class="fas fa-calendar-alt"></i> Month
                            </label>
                            <select id="csvMonth"
                                    style="width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem;">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>

                        <!-- File picker -->
                        <div style="flex: 1; min-width: 220px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                                <i class="fas fa-file-upload"></i> CSV File
                            </label>
                            <input type="file" id="csvFileInput" accept=".csv"
                                   style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.9rem;"
                                   onchange="previewCsv()">
                        </div>
                    </div>

                    <!-- Preview area -->
                    <div id="csvPreviewArea" style="display: none; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1rem;">
                            <i class="fas fa-eye"></i> Preview
                            <span id="csvPreviewCount" class="badge badge-info" style="font-size: 0.8rem; margin-left: 8px;"></span>
                        </h4>
                        <div style="overflow-x: auto; max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px;">
                            <table class="user-table" id="csvPreviewTable" style="margin: 0;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Description</th>
                                        <th>Credit</th>
                                        <th>Debit</th>
                                        <th>Note</th>
                                        <th>Method</th>
                                    </tr>
                                </thead>
                                <tbody id="csvPreviewBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Import / Clear buttons -->
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn-sm btn-success" id="csvImportBtn" onclick="importCsv()" disabled>
                            <i class="fas fa-upload"></i> Import Transactions
                        </button>
                        <button class="btn-sm btn-secondary" id="csvClearBtn" onclick="clearCsvForm()" style="display: none;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <span id="csvImportStatus" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Monthly Record Tab -->
        <div class="tab-pane fade" id="records-pane" role="tabpanel" aria-labelledby="records-tab">
            <div class="section-card">
                <div class="section-header">
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">
                        <i class="fas fa-calendar-times"></i> Delete Monthly Record
                    </h2>
                </div>
                <div class="section-body">
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        Delete a monthly record and <strong>all its transactions</strong> for a specific user. This action cannot be undone.
                    </p>

                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px;">
                        <!-- User selector -->
                        <div style="flex: 1; min-width: 180px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                                <i class="fas fa-user"></i> User
                            </label>
                            <select id="delRecordUserId" onchange="loadMonthlyRecords()"
                                    style="width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem;">
                                <option value="">-- Select User --</option>
                                {% for user in users %}
                                {% if user.is_active %}
                                <option value="{{ user.id }}">{{ user.username }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Monthly record selector (populated dynamically) -->
                        <div style="flex: 2; min-width: 260px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                                <i class="fas fa-calendar-alt"></i> Monthly Record
                            </label>
                            <select id="delRecordSelect" disabled
                                    style="width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem;">
                                <option value="">-- Select a user first --</option>
                            </select>
                        </div>

                        <!-- Delete button -->
                        <div>
                            <button class="btn-sm btn-danger" id="delRecordBtn" onclick="showDeleteRecordModal()" disabled>
                                <i class="fas fa-trash"></i> Delete Record
                            </button>
                        </div>
                    </div>
                    <span id="delRecordStatus" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
                </div>
            </div>
        </div>

        <!-- User Management Tab -->
        <div class="tab-pane fade" id="users-pane" role="tabpanel" aria-labelledby="users-tab">
            <div class="section-card">
                <div class="section-header">
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">
                        <i class="fas fa-users"></i> User Management
                    </h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text"
                               id="userSearch"
                               class="search-box"
                               placeholder="Search by username, email, or ID..."
                               onkeyup="filterUsers()">
                        <button class="btn-sm btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="section-body" style="overflow-x: auto;">
                    {% if users %}
                    <table class="user-table" id="userTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Last Login</th>
                                <th>Created</th>
                                <th>Records</th>
                                <th>Transactions</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            {% for user in users %}
                            <tr class="user-row" data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-email="{{ user.email }}">
                                <td>{{ user.id }}</td>
                                <td><strong>{{ user.username }}</strong></td>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% if user.is_active %}
                                    <span class="badge badge-success">Active</span>
                                    {% else %}
                                    <span class="badge badge-danger">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_admin %}
                                    <span class="badge badge-primary">Admin</span>
                                    {% else %}
                                    <span class="badge badge-secondary">User</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'N/A' }}</td>
                                <td>{{ user.monthly_records_count or 0 }}</td>
                                <td>{{ user.transactions_count or 0 }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-sm {{ 'btn-warning' if user.is_active else 'btn-success' }}"
                                                onclick="toggleUserActive({{ user.id }}, '{{ user.username }}')"
                                                title="{{ 'Deactivate' if user.is_active else 'Activate' }} user"
                                                {% if user.id == current_user_id %}disabled{% endif %}>
                                            <i class="fas fa-{{ 'ban' if user.is_active else 'check' }}"></i>
                                        </button>
                                        <button class="btn-sm {{ 'btn-secondary' if user.is_admin else 'btn-primary' }}"
                                                onclick="toggleUserAdmin({{ user.id }}, '{{ user.username }}')"
                                                title="{{ 'Revoke' if user.is_admin else 'Grant' }} admin"
                                                {% if user.id == current_user_id %}disabled{% endif %}>
                                            <i class="fas fa-user-shield"></i>
                                        </button>
                                        <button class="btn-sm btn-danger"
                                                onclick="showDeleteModal({{ user.id }}, '{{ user.username }}')"
                                                title="Delete user"
                                                {% if user.id == current_user_id %}disabled{% endif %}>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted" style="text-align: center; padding: 40px;">No users found in the database.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Audit Logs Tab -->
        <div class="tab-pane fade" id="audit-pane" role="tabpanel" aria-labelledby="audit-tab">
            <div class="section-card">
                <div class="section-header">
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">
                        <i class="fas fa-history"></i> Audit Logs
                        <span class="badge badge-secondary" style="font-size: 0.75rem; margin-left: 10px;">Last 50</span>
                    </h2>
                    <button class="btn-sm btn-primary" onclick="refreshAuditLogs()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="section-body" style="overflow-x: auto;">
                    {% if audit_logs %}
                    <table class="audit-table" id="auditTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Admin</th>
                                <th>Action</th>
                                <th>Target User</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in audit_logs %}
                            <tr>
                                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') if log.created_at else 'N/A' }}</td>
                                <td><strong>{{ log.admin_username }}</strong></td>
                                <td><span class="badge badge-info">{{ log.action }}</span></td>
                                <td>{{ log.target_username or 'N/A' }}</td>
                                <td>{{ log.details or '' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted" style="text-align: center; padding: 40px;">No audit logs available.</p>
                    {% endif %}
                </div>
            </div>
        </div>

    </div><!-- /tab-content -->
</div>

<!-- CSV Import Confirmation Modal -->
<div class="modal fade" id="csvImportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color, #dee2e6);">
                <h5 class="modal-title">
                    <i class="fas fa-file-import"></i> Confirm CSV Import
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary -->
                <p style="margin-bottom: 15px;">
                    Importing <strong id="csvModalRowCount"></strong> transactions
                    for <strong id="csvModalTarget"></strong>.
                </p>

                <!-- Payment Method Mapping -->
                <div id="csvMethodMappingArea" style="display: none;">
                    <h6 style="margin: 0 0 10px 0; font-weight: 600;">
                        <i class="fas fa-exchange-alt"></i> Map Payment Methods
                    </h6>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 10px;">
                        Map each CSV payment method to an existing one, or choose to create a new one.
                    </p>
                    <div style="overflow-x: auto; border: 1px solid var(--border-color); border-radius: 6px;">
                        <table class="user-table" id="csvMethodMappingTable" style="margin: 0;">
                            <thead>
                                <tr>
                                    <th style="min-width: 150px;">CSV Method</th>
                                    <th>Used In</th>
                                    <th style="min-width: 220px;">Map To</th>
                                </tr>
                            </thead>
                            <tbody id="csvMethodMappingBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="csvNoMethodsNote" style="display: none; color: var(--text-secondary); font-size: 0.9rem; font-style: italic;">
                    No payment methods found in the CSV — none to map.
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color, #dee2e6);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" id="csvModalConfirmBtn" onclick="executeImport()">
                    <i class="fas fa-upload"></i> Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Monthly Record Confirmation Modal -->
<div class="modal fade" id="deleteRecordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color, #dee2e6);">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger"></i> Delete Monthly Record
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="delRecordLabel"></strong>?</p>
                <div class="alert alert-danger" role="alert" style="margin-bottom: 0;">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Warning:</strong> This will permanently delete the monthly record and
                    <strong id="delRecordTxnCount"></strong> transaction(s). This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color, #dee2e6);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteRecordBtn" onclick="executeDeleteRecord()">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color, #dee2e6);">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger"></i> Confirm Delete User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete user <strong id="deleteUsername"></strong>?</p>
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Warning:</strong> This action cannot be undone. All user data including transactions and records will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color, #dee2e6);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> Delete User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Alert Toast -->
<div id="alertToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: none; min-width: 300px;">
    <div class="alert alert-dismissible fade show" role="alert" id="alertContent" style="box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <span id="alertMessage"></span>
        <button type="button" class="btn-close" onclick="hideAlert()"></button>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    console.log('Admin Dashboard JavaScript Loaded');
    console.log('Users loaded:', {{ users|length }});
    console.log('Audit logs loaded:', {{ audit_logs|length }});

    let currentDeleteUserId = null;
    let deleteModal = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded');
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        // CRITICAL FIX: Remove any lingering modal backdrops or overlays
        clearModalBackdrops();

        // Remove any bootstrap modal-open class that might block scrolling
        document.body.classList.remove('modal-open');

        // Remove inline styles that might block interaction
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';

        console.log('Admin page initialized and cleared of overlays');
    });

    // Function to clear all modal backdrops and overlays
    function clearModalBackdrops() {
        // Remove all modal backdrops
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            console.log('Removing modal backdrop');
            backdrop.remove();
        });

        // Ensure body doesn't have modal-open class
        document.body.classList.remove('modal-open');

        // Reset body overflow
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }

    // Clear backdrops when modal is hidden
    document.getElementById('deleteModal').addEventListener('hidden.bs.modal', function() {
        setTimeout(clearModalBackdrops, 100);
    });

    // Filter users based on search input
    function filterUsers() {
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        const rows = document.querySelectorAll('.user-row');

        rows.forEach(row => {
            const userId = row.getAttribute('data-user-id');
            const username = row.getAttribute('data-username').toLowerCase();
            const email = row.getAttribute('data-email').toLowerCase();

            if (userId.includes(searchTerm) || username.includes(searchTerm) || email.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Show alert message
    function showAlert(message, type = 'success') {
        const alertToast = document.getElementById('alertToast');
        const alertContent = document.getElementById('alertContent');
        const alertMessage = document.getElementById('alertMessage');

        alertContent.className = `alert alert-${type} alert-dismissible fade show`;
        alertMessage.textContent = message;
        alertToast.style.display = 'block';

        setTimeout(() => {
            hideAlert();
        }, 5000);
    }

    // Hide alert
    function hideAlert() {
        document.getElementById('alertToast').style.display = 'none';
    }

    // Toggle user active status
    async function toggleUserActive(userId, username) {
        if (!confirm(`Are you sure you want to toggle ${username}'s account status?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/users/${userId}/toggle-active`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to update user', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
        }
    }

    // Toggle user admin status
    async function toggleUserAdmin(userId, username) {
        if (!confirm(`Are you sure you want to modify ${username}'s admin privileges?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/users/${userId}/toggle-admin`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to update user', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
        }
    }

    // Show delete confirmation modal
    function showDeleteModal(userId, username) {
        currentDeleteUserId = userId;
        document.getElementById('deleteUsername').textContent = username;
        deleteModal.show();
    }

    // Confirm and execute delete
    async function confirmDelete() {
        if (!currentDeleteUserId) return;

        const deleteBtn = document.getElementById('confirmDeleteBtn');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        try {
            const response = await fetch(`/api/admin/users/${currentDeleteUserId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                deleteModal.hide();
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to delete user', 'danger');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalText;
        }
    }

    // Refresh all data
    function refreshData() {
        showAlert('Refreshing data...', 'info');
        setTimeout(() => location.reload(), 500);
    }

    // Refresh audit logs
    function refreshAuditLogs() {
        showAlert('Refreshing audit logs...', 'info');
        setTimeout(() => location.reload(), 500);
    }

    // Debug helper: Log if any element is blocking clicks
    window.addEventListener('click', function(e) {
        const target = e.target;
        const computedStyle = window.getComputedStyle(target);
        if (computedStyle.pointerEvents === 'none') {
            console.warn('Click blocked on element:', target, 'pointer-events:', computedStyle.pointerEvents);
        }
    });

    // Periodic check to remove any rouge overlays (safety net)
    setInterval(function() {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0 && !document.querySelector('.modal.show')) {
            console.log('Found rouge modal backdrop, removing...');
            clearModalBackdrops();
        }
    }, 2000);

    console.log('Admin Dashboard fully initialized - All overlays cleared');

    // ── System Settings: refresh mode ───────────────────────────
    const _modeOriginal = document.querySelector('input[name="refreshMode"]:checked').value;

    function onModeChange() {
        const current = document.querySelector('input[name="refreshMode"]:checked').value;
        document.getElementById('saveModeBtn').disabled = (current === _modeOriginal);
        const isBackground = (current === 'background');
        document.getElementById('intervalRow').style.display  = isBackground ? 'flex'  : 'none';
        document.getElementById('intervalDesc').style.display = isBackground ? 'block' : 'none';
    }

    async function saveRefreshMode() {
        const value = document.querySelector('input[name="refreshMode"]:checked').value;
        const btn   = document.getElementById('saveModeBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving\u2026';

        try {
            const response = await fetch('/api/admin/settings/exchange_rate_refresh_mode', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: value })
            });
            const data = await response.json();
            if (response.ok) {
                showAlert('Refresh mode set to \u201c' + value + '\u201d', 'success');
                btn.innerHTML = '<i class="fas fa-save"></i> Save';
                // keep disabled — value now matches server
            } else {
                showAlert(data.error || 'Failed to update setting', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save';
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Save';
        }
    }

    // ── System Settings: on-demand refresh ───────────────────────
    async function refreshAllRates() {
        const btn = document.getElementById('refreshAllBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing\u2026';

        try {
            const response = await fetch('/api/exchange-rate/refresh-all');
            const data = await response.json();

            if (data.sources) {
                // Build a per-source summary from the detailed response
                const lines = Object.entries(data.sources).map(([name, info]) => {
                    if (info.status === 'success') {
                        return name + ': Buy ' + info.buy_rate + ' / Sell ' + info.sell_rate;
                    }
                    return name + ': FAILED \u2014 ' + (info.error || 'unknown');
                });

                const anyFailed = (data.failed && data.failed.length > 0);
                const allFailed = (data.succeeded && data.succeeded.length === 0);
                showAlert(
                    data.message + '<br>' + lines.join('<br>'),
                    allFailed ? 'danger' : anyFailed ? 'warning' : 'success'
                );
            } else if (response.ok) {
                showAlert(data.message || 'Exchange rates refreshed', 'success');
            } else {
                showAlert(data.error || 'Refresh failed', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh All Rates Now';
    }

    // ── Database Backup ────────────────────────────────────────
    async function downloadDbBackup() {
        const btn = document.getElementById('dbBackupBtn');
        const status = document.getElementById('dbBackupStatus');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating backup\u2026';
        status.textContent = 'This may take a moment for large databases.';

        try {
            const response = await fetch('/api/admin/db-backup');

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Backup failed');
            }

            // Get filename from Content-Disposition header
            const disposition = response.headers.get('Content-Disposition');
            let fname = 'database_backup.sql';
            if (disposition) {
                const match = disposition.match(/filename=([^\s;]+)/);
                if (match) fname = match[1];
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fname;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

            const sizeMB = (blob.size / (1024 * 1024)).toFixed(2);
            status.textContent = `Backup downloaded (${sizeMB} MB)`;
            showAlert('Database backup downloaded successfully', 'success');
        } catch (error) {
            console.error('Error:', error);
            status.textContent = '';
            showAlert('Backup failed: ' + error.message, 'danger');
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download"></i> Download Full Backup';
    }

    // ── System Settings: refresh interval ──────────────────────
    // Save button stays disabled until the value actually changes
    const _intervalOriginal = document.getElementById('refreshIntervalInput').value;

    function markIntervalDirty() {
        const current = document.getElementById('refreshIntervalInput').value;
        document.getElementById('saveIntervalBtn').disabled = (current === _intervalOriginal);
    }

    async function saveRefreshInterval() {
        const input = document.getElementById('refreshIntervalInput');
        const value = input.value.trim();

        if (!value || parseInt(value) < 1) {
            showAlert('Interval must be at least 1 minute', 'danger');
            return;
        }

        const btn = document.getElementById('saveIntervalBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving…';

        try {
            const response = await fetch('/api/admin/settings/exchange_rate_refresh_interval_minutes', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: value })
            });

            const data = await response.json();

            if (response.ok) {
                showAlert('Refresh interval updated to ' + value + ' minutes', 'success');
                btn.innerHTML = '<i class="fas fa-save"></i> Save';
                // keep button disabled — value now matches what the server has
            } else {
                showAlert(data.error || 'Failed to update setting', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save';
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Save';
        }
    }

    // ── CSV Import ──────────────────────────────────────────────
    let csvImportModalInstance = null;
    // Unique CSV methods extracted during preview (for method mapping)
    let csvUniqueMethods = [];
    // Payment methods fetched from DB for the selected user
    let userPaymentMethods = [];

    const MONTH_NAMES = ['', 'January','February','March','April','May','June',
                         'July','August','September','October','November','December'];

    // Set default year/month to current
    (function() {
        const now = new Date();
        document.getElementById('csvYear').value = now.getFullYear();
        document.getElementById('csvMonth').value = now.getMonth() + 1;
    })();

    document.addEventListener('DOMContentLoaded', function() {
        csvImportModalInstance = new bootstrap.Modal(document.getElementById('csvImportModal'));
        document.getElementById('csvImportModal').addEventListener('hidden.bs.modal', function() {
            setTimeout(clearModalBackdrops, 100);
        });
        deleteRecordModalInstance = new bootstrap.Modal(document.getElementById('deleteRecordModal'));
        document.getElementById('deleteRecordModal').addEventListener('hidden.bs.modal', function() {
            setTimeout(clearModalBackdrops, 100);
        });
    });

    function previewCsv() {
        const fileInput = document.getElementById('csvFileInput');
        const previewArea = document.getElementById('csvPreviewArea');
        const previewBody = document.getElementById('csvPreviewBody');
        const previewCount = document.getElementById('csvPreviewCount');
        const importBtn = document.getElementById('csvImportBtn');

        previewBody.innerHTML = '';
        previewArea.style.display = 'none';
        importBtn.disabled = true;
        csvUniqueMethods = [];

        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split(/\r?\n/).filter(l => l.trim());
            if (lines.length < 2) {
                showAlert('CSV file must have a header row and at least one data row', 'danger');
                return;
            }

            // Parse header
            const headerLine = lines[0];
            const headers = parseCSVLine(headerLine).map(h => h.trim().toLowerCase());
            const descIdx = headers.indexOf('description');
            const creditIdx = headers.indexOf('credit');
            const debitIdx = headers.indexOf('debit');
            const noteIdx = headers.findIndex(h => h === 'note' || h === 'notes');
            const methodIdx = headers.findIndex(h => h === 'method' || h === 'payment method');

            if (descIdx === -1) {
                showAlert('CSV must have a "Description" column', 'danger');
                return;
            }

            // Track method usage counts
            const methodCounts = {};
            let rowCount = 0;

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                const desc = (cols[descIdx] || '').trim();
                if (!desc) continue;

                const method = methodIdx >= 0 ? (cols[methodIdx] || '').trim() : '';
                if (method) {
                    methodCounts[method] = (methodCounts[method] || 0) + 1;
                }

                rowCount++;
                const tr = document.createElement('tr');
                tr.innerHTML =
                    '<td>' + rowCount + '</td>' +
                    '<td>' + escHtml(desc) + '</td>' +
                    '<td>' + escHtml(creditIdx >= 0 ? (cols[creditIdx] || '').trim() : '') + '</td>' +
                    '<td>' + escHtml(debitIdx >= 0 ? (cols[debitIdx] || '').trim() : '') + '</td>' +
                    '<td>' + escHtml(noteIdx >= 0 ? (cols[noteIdx] || '').trim() : '') + '</td>' +
                    '<td>' + escHtml(method) + '</td>';
                previewBody.appendChild(tr);
            }

            // Store unique methods with counts
            csvUniqueMethods = Object.entries(methodCounts).map(
                ([name, count]) => ({ name, count })
            );

            if (rowCount > 0) {
                previewCount.textContent = rowCount + ' row' + (rowCount !== 1 ? 's' : '');
                previewArea.style.display = 'block';
                importBtn.disabled = false;
                document.getElementById('csvClearBtn').style.display = '';
            } else {
                showAlert('No valid data rows found in CSV', 'danger');
            }
        };
        reader.readAsText(file);
    }

    function clearCsvForm() {
        document.getElementById('csvFileInput').value = '';
        document.getElementById('csvPreviewArea').style.display = 'none';
        document.getElementById('csvPreviewBody').innerHTML = '';
        document.getElementById('csvImportBtn').disabled = true;
        document.getElementById('csvClearBtn').style.display = 'none';
        document.getElementById('csvImportStatus').textContent = '';
        csvUniqueMethods = [];
    }

    // Simple CSV line parser that handles quoted fields
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (inQuotes) {
                if (ch === '"' && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else if (ch === '"') {
                    inQuotes = false;
                } else {
                    current += ch;
                }
            } else {
                if (ch === '"') {
                    inQuotes = true;
                } else if (ch === ',') {
                    result.push(current);
                    current = '';
                } else {
                    current += ch;
                }
            }
        }
        result.push(current);
        return result;
    }

    function escHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Called when user clicks "Import Transactions" — opens the mapping modal
    async function importCsv() {
        const userId = document.getElementById('csvUserId').value;
        const year = document.getElementById('csvYear').value;
        const month = document.getElementById('csvMonth').value;
        const fileInput = document.getElementById('csvFileInput');

        if (!userId) { showAlert('Please select a user', 'danger'); return; }
        if (!year) { showAlert('Please enter a year', 'danger'); return; }
        if (!fileInput.files[0]) { showAlert('Please select a CSV file', 'danger'); return; }

        const rowCount = document.getElementById('csvPreviewBody').children.length;
        const selectedUser = document.getElementById('csvUserId');
        const username = selectedUser.options[selectedUser.selectedIndex].text;

        // Populate modal summary
        document.getElementById('csvModalRowCount').textContent = rowCount + ' row' + (rowCount !== 1 ? 's' : '');
        document.getElementById('csvModalTarget').textContent = username + ' — ' + MONTH_NAMES[parseInt(month)] + ' ' + year;

        // Fetch payment methods for the selected user
        const mappingArea = document.getElementById('csvMethodMappingArea');
        const noMethodsNote = document.getElementById('csvNoMethodsNote');
        const mappingBody = document.getElementById('csvMethodMappingBody');
        mappingBody.innerHTML = '';
        mappingArea.style.display = 'none';
        noMethodsNote.style.display = 'none';

        if (csvUniqueMethods.length > 0) {
            try {
                const resp = await fetch('/api/admin/users/' + userId + '/payment-methods');
                userPaymentMethods = resp.ok ? await resp.json() : [];
            } catch (e) {
                userPaymentMethods = [];
            }

            // Build mapping rows
            csvUniqueMethods.forEach(function(m) {
                const tr = document.createElement('tr');

                // CSV Method name
                const tdName = document.createElement('td');
                tdName.innerHTML = '<strong>' + escHtml(m.name) + '</strong>';
                tr.appendChild(tdName);

                // Usage count
                const tdCount = document.createElement('td');
                tdCount.textContent = m.count + ' row' + (m.count !== 1 ? 's' : '');
                tdCount.style.color = 'var(--text-secondary)';
                tr.appendChild(tdCount);

                // Mapping dropdown
                const tdMap = document.createElement('td');
                const select = document.createElement('select');
                select.setAttribute('data-csv-method', m.name);
                select.style.cssText = 'width:100%;padding:6px 8px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-tertiary);color:var(--text-primary);font-size:0.9rem;';

                // Check if there's an auto-match (case-insensitive)
                const autoMatch = userPaymentMethods.find(
                    pm => pm.name.toLowerCase() === m.name.toLowerCase()
                );

                // Option: Create new
                const optCreate = document.createElement('option');
                optCreate.value = '__create__';
                optCreate.textContent = '+ Create new "' + m.name + '"';
                select.appendChild(optCreate);

                // Option: Skip (no method)
                const optSkip = document.createElement('option');
                optSkip.value = '__skip__';
                optSkip.textContent = '— None (skip)';
                select.appendChild(optSkip);

                // Separator
                if (userPaymentMethods.length > 0) {
                    const optSep = document.createElement('option');
                    optSep.disabled = true;
                    optSep.textContent = '── Existing methods ──';
                    select.appendChild(optSep);
                }

                // Existing methods
                userPaymentMethods.forEach(function(pm) {
                    const opt = document.createElement('option');
                    opt.value = pm.id;
                    opt.textContent = pm.name;
                    if (autoMatch && autoMatch.id === pm.id) {
                        opt.selected = true;
                    }
                    select.appendChild(opt);
                });

                // If auto-match found, select it; otherwise default stays on __create__
                if (autoMatch) {
                    select.value = String(autoMatch.id);
                }

                tdMap.appendChild(select);
                tr.appendChild(tdMap);
                mappingBody.appendChild(tr);
            });

            mappingArea.style.display = 'block';
        } else {
            noMethodsNote.style.display = 'block';
        }

        // Reset confirm button state
        const confirmBtn = document.getElementById('csvModalConfirmBtn');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-upload"></i> Import';

        csvImportModalInstance.show();
    }

    // Called when user clicks "Import" inside the modal
    async function executeImport() {
        const userId = document.getElementById('csvUserId').value;
        const year = document.getElementById('csvYear').value;
        const month = document.getElementById('csvMonth').value;
        const fileInput = document.getElementById('csvFileInput');

        // Build method mapping from dropdown selections
        const methodMapping = {};
        document.querySelectorAll('#csvMethodMappingBody select[data-csv-method]').forEach(function(sel) {
            methodMapping[sel.getAttribute('data-csv-method')] = sel.value;
        });

        const confirmBtn = document.getElementById('csvModalConfirmBtn');
        const statusEl = document.getElementById('csvImportStatus');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
        statusEl.textContent = '';

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('user_id', userId);
        formData.append('year', year);
        formData.append('month', month);
        if (Object.keys(methodMapping).length > 0) {
            formData.append('method_mapping', JSON.stringify(methodMapping));
        }

        try {
            const response = await fetch('/api/admin/import-csv', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            csvImportModalInstance.hide();

            if (response.ok) {
                showAlert(data.message, 'success');
                statusEl.textContent = data.message;
                if (data.methods_created && data.methods_created.length > 0) {
                    statusEl.textContent += ' | New payment methods: ' + data.methods_created.join(', ');
                }
                // Reset form
                fileInput.value = '';
                document.getElementById('csvPreviewArea').style.display = 'none';
                document.getElementById('csvPreviewBody').innerHTML = '';
                document.getElementById('csvImportBtn').disabled = true;
                document.getElementById('csvClearBtn').style.display = 'none';
                csvUniqueMethods = [];
            } else {
                showAlert(data.error || 'Import failed', 'danger');
                statusEl.textContent = data.error || 'Import failed';
            }
        } catch (error) {
            csvImportModalInstance.hide();
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
            statusEl.textContent = 'Network error';
        }

        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-upload"></i> Import';
    }

    // ── Delete Monthly Record ───────────────────────────────────
    let deleteRecordModalInstance = null;
    let deleteRecordMeta = null; // { userId, recordId, label, txnCount }

    async function loadMonthlyRecords() {
        const userId = document.getElementById('delRecordUserId').value;
        const select = document.getElementById('delRecordSelect');
        const btn = document.getElementById('delRecordBtn');

        select.innerHTML = '';
        btn.disabled = true;

        if (!userId) {
            select.innerHTML = '<option value="">-- Select a user first --</option>';
            select.disabled = true;
            return;
        }

        select.innerHTML = '<option value="">Loading...</option>';
        select.disabled = true;

        try {
            const resp = await fetch('/api/admin/users/' + userId + '/monthly-records');
            const records = resp.ok ? await resp.json() : [];

            select.innerHTML = '';

            if (records.length === 0) {
                select.innerHTML = '<option value="">No records found</option>';
                select.disabled = true;
                return;
            }

            const optDefault = document.createElement('option');
            optDefault.value = '';
            optDefault.textContent = '-- Select a month --';
            select.appendChild(optDefault);

            records.forEach(function(r) {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.setAttribute('data-txn-count', r.transaction_count);
                opt.textContent = r.month_name + ' ' + r.year +
                    ' (' + r.transaction_count + ' txn' + (r.transaction_count !== 1 ? 's' : '') + ')';
                select.appendChild(opt);
            });

            select.disabled = false;
            select.onchange = function() {
                btn.disabled = !select.value;
            };
        } catch (e) {
            select.innerHTML = '<option value="">Failed to load</option>';
            select.disabled = true;
        }
    }

    function showDeleteRecordModal() {
        const userId = document.getElementById('delRecordUserId').value;
        const select = document.getElementById('delRecordSelect');
        const recordId = select.value;

        if (!userId || !recordId) return;

        const selectedOpt = select.options[select.selectedIndex];
        const label = selectedOpt.textContent.split(' (')[0]; // e.g. "January 2025"
        const txnCount = selectedOpt.getAttribute('data-txn-count') || '0';

        deleteRecordMeta = { userId, recordId, label, txnCount };

        document.getElementById('delRecordLabel').textContent = label;
        document.getElementById('delRecordTxnCount').textContent = txnCount;

        const confirmBtn = document.getElementById('confirmDeleteRecordBtn');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';

        deleteRecordModalInstance.show();
    }

    async function executeDeleteRecord() {
        if (!deleteRecordMeta) return;

        const confirmBtn = document.getElementById('confirmDeleteRecordBtn');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        try {
            const resp = await fetch(
                '/api/admin/users/' + deleteRecordMeta.userId +
                '/monthly-records/' + deleteRecordMeta.recordId,
                { method: 'DELETE' }
            );
            const data = await resp.json();

            deleteRecordModalInstance.hide();

            if (resp.ok) {
                showAlert(data.message, 'success');
                document.getElementById('delRecordStatus').textContent = data.message;
                // Refresh the records dropdown
                loadMonthlyRecords();
            } else {
                showAlert(data.error || 'Delete failed', 'danger');
                document.getElementById('delRecordStatus').textContent = data.error || 'Delete failed';
            }
        } catch (error) {
            deleteRecordModalInstance.hide();
            console.error('Error:', error);
            showAlert('Network error: ' + error.message, 'danger');
        }

        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        deleteRecordMeta = null;
    }

    // ── Tab persistence via URL hash ────────────────────────────
    (function() {
        // Map hash values to tab IDs
        const tabMap = {
            '#settings': 'settings-tab',
            '#csv-import': 'csv-tab',
            '#delete-records': 'records-tab',
            '#users': 'users-tab',
            '#audit-logs': 'audit-tab'
        };

        // Reverse map: tab ID to hash
        const hashMap = {
            'settings-tab': '#settings',
            'csv-tab': '#csv-import',
            'records-tab': '#delete-records',
            'users-tab': '#users',
            'audit-tab': '#audit-logs'
        };

        // On page load, activate the tab from the URL hash
        document.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash;
            if (hash && tabMap[hash]) {
                const tabEl = document.getElementById(tabMap[hash]);
                if (tabEl) {
                    const tab = new bootstrap.Tab(tabEl);
                    tab.show();
                }
            }

            // Update hash when a tab is clicked
            document.querySelectorAll('#adminTabs button[data-bs-toggle="tab"]').forEach(function(btn) {
                btn.addEventListener('shown.bs.tab', function(e) {
                    const tabId = e.target.id;
                    if (hashMap[tabId]) {
                        history.replaceState(null, null, hashMap[tabId]);
                    }
                });
            });
        });
    })();
</script>
{% endblock %}
