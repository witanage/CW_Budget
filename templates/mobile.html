<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile View - Personal Finance</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">

    <!-- Chart.js for Bank Comparison -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="mobile-header">
        <div class="header-top">
            <h1><i class="fas fa-table me-2"></i>Transactions</h1>
            <div class="header-buttons">
                {% if session.is_admin %}
                <a href="/admin" class="btn-back" style="background: linear-gradient(135deg, #0866ff, #0645b8); border: none;">
                    <i class="fas fa-user-shield"></i>Admin
                </a>
                {% endif %}
                <a href="/dashboard" class="btn-back">
                    <i class="fas fa-desktop"></i>Desktop
                </a>
                <div class="mobile-user-dropdown">
                    <button class="mobile-user-btn" id="mobileUserBtn">
                        <div class="mobile-user-avatar">
                            <span class="mobile-user-initials">{{ session.username[0]|upper }}</span>
                        </div>
                        <i class="fas fa-chevron-down" style="font-size: 0.6rem; margin-left: 4px;"></i>
                    </button>
                    <div class="mobile-dropdown-menu" id="mobileUserDropdown">
                        <!-- User Info Header -->
                        <div class="mobile-user-header">
                            <div class="mobile-user-avatar-large">
                                <span class="mobile-user-initials-large">{{ session.username[0]|upper }}</span>
                            </div>
                            <div class="mobile-user-info">
                                <div class="mobile-user-name">{{ session.username }}</div>
                                <div class="mobile-user-role">
                                    {% if session.is_admin %}
                                    <i class="fas fa-user-shield me-1"></i>Administrator
                                    {% else %}
                                    <i class="fas fa-user me-1"></i>User
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="mobile-dropdown-divider"></div>

                        <!-- Navigation Section -->
                        <div class="mobile-dropdown-label">Navigation</div>
                        <a href="/dashboard" class="mobile-dropdown-item">
                            <i class="fas fa-tachometer-alt"></i>Dashboard
                        </a>
                        {% if session.is_admin %}
                        <a href="/admin" class="mobile-dropdown-item">
                            <i class="fas fa-user-shield"></i>Admin Panel
                        </a>
                        {% endif %}
                        <div class="mobile-dropdown-divider"></div>

                        <!-- Settings Section -->
                        <div class="mobile-dropdown-label">Settings</div>
                        <a href="#" class="mobile-dropdown-item" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="fas fa-key"></i>Change Password
                        </a>
                        <a href="#" class="mobile-dropdown-item" id="mobileThemeToggle">
                            <i class="fas fa-moon" id="mobileThemeIcon"></i>
                            <span id="mobileThemeText">Light Theme</span>
                        </a>
                        <div class="mobile-dropdown-divider"></div>

                        <!-- Logout -->
                        <a href="/logout" class="mobile-dropdown-item mobile-dropdown-item-logout">
                            <i class="fas fa-sign-out-alt"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="month-nav">
            <button id="prevMonthBtn" onclick="navigateToPreviousMonth()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="month-display" id="monthDisplay">Loading...</div>
            <button id="nextMonthBtn" onclick="navigateToNextMonth()">
                <i class="fas fa-chevron-right"></i>
            </button>
            <div class="action-buttons">
                <button class="action-btn" onclick="refreshTransactions()" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="action-btn" data-bs-toggle="modal" data-bs-target="#paymentTotalsModal" title="Payment Totals">
                    <i class="fas fa-credit-card"></i>
                </button>
                <button class="action-btn" data-bs-toggle="modal" data-bs-target="#bankComparisonModal" title="Bank Comparison">
                    <i class="fas fa-chart-line"></i>
                </button>
            </div>
        </div>
        <!-- Table Headers (Fixed with mobile header) -->
        <div class="table-header-row">
            <div class="table-header-cell col-desc">Description</div>
            <div class="table-header-cell col-debit">Debit</div>
            <div class="table-header-cell col-credit">Credit</div>
            <div class="table-header-cell col-balance">Balance</div>
        </div>
    </div>

    <!-- Excel-like Table View -->
    <div class="mobile-content">
        <table class="excel-table" id="transactionsTable">
            <tbody id="transactionsList">
                <tr>
                    <td colspan="4">
                        <div class="no-transactions">
                            <i class="fas fa-receipt fa-3x mb-3"></i>
                            <p>No transactions yet</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Floating Add Button -->
    <button class="add-btn-float" data-bs-toggle="modal" data-bs-target="#transactionModal">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #1a1a1a; color: #ffffff;">
                <div class="modal-header" style="border-bottom: 1px solid #333;">
                    <h5 class="modal-title">Add Transaction</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transactionForm">
                        <div class="mb-3">
                            <label for="transDescription" class="form-label" style="color: #aaa;">Description</label>
                            <input type="text" class="form-control" id="transDescription" required style="background: #0d0d0d; border-color: #333; color: #fff;">
                        </div>
                        <div class="mb-3">
                            <label for="transCategory" class="form-label" style="color: #aaa;">Category</label>
                            <div class="d-flex gap-2 align-items-start">
                                <select class="form-select" id="transCategory" style="background: #0d0d0d; border-color: #333; color: #fff;">
                                    <!-- Categories will be loaded here -->
                                </select>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="toggleNewCategoryBtn" style="white-space: nowrap;">
                                    <i class="fas fa-plus"></i> New
                                </button>
                            </div>

                            <!-- Inline category creation form (initially hidden) -->
                            <div id="newCategoryForm" class="mt-2" style="display: none;">
                                <div class="card border-primary">
                                    <div class="card-body p-2" style="background: #0d0d0d;">
                                        <h6 class="card-title mb-2" style="font-size: 0.875rem; color: #fff;">
                                            <i class="fas fa-plus-circle me-1"></i>Add New Category
                                        </h6>
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" id="newCategoryName" placeholder="Category name" maxlength="255" style="background: #1a1a1a; border-color: #333; color: #fff;">
                                        </div>
                                        <div class="mb-2">
                                            <select class="form-select form-select-sm" id="newCategoryType" style="background: #1a1a1a; border-color: #333; color: #fff;">
                                                <option value="">Select type...</option>
                                                <option value="income">Income</option>
                                                <option value="expense">Expense</option>
                                            </select>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-primary btn-sm flex-fill" id="saveNewCategoryBtn">
                                                <i class="fas fa-check me-1"></i>Save
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm flex-fill" id="cancelNewCategoryBtn">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                        </div>
                                        <div id="newCategoryMessage" class="mt-2" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="transDebit" class="form-label" style="color: #aaa;">Debit (Income)</label>
                            <input type="number" class="form-control" id="transDebit" placeholder="0.00" step="0.01" style="background: #0d0d0d; border-color: #333; color: #fff;">
                        </div>
                        <div class="mb-3">
                            <label for="transCredit" class="form-label" style="color: #aaa;">Credit (Expense)</label>
                            <input type="number" class="form-control" id="transCredit" placeholder="0.00" step="0.01" style="background: #0d0d0d; border-color: #333; color: #fff;">
                        </div>
                        <div class="mb-3">
                            <label for="transDate" class="form-label" style="color: #aaa;">Date</label>
                            <input type="date" class="form-control" id="transDate" style="background: #0d0d0d; border-color: #333; color: #fff;">
                        </div>
                        <div class="mb-3">
                            <label for="transNotes" class="form-label" style="color: #aaa;">Notes</label>
                            <textarea class="form-control" id="transNotes" rows="2" style="background: #0d0d0d; border-color: #333; color: #fff;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #333;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTransactionBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Totals Modal -->
    <div class="modal fade" id="paymentTotalsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content" style="background: #1a1a1a; color: #ffffff;">
                <div class="modal-header" style="border-bottom: 1px solid #333;">
                    <h5 class="modal-title">Payment Method Totals</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="paymentTotalsContainer">
                        <div class="text-center" style="color: #cccccc;">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #333;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #1a1a1a; color: #ffffff;">
                <div class="modal-header" style="border-bottom: 1px solid #333;">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label" style="color: #aaa;">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required style="background: #0d0d0d; border-color: #333; color: #fff;">
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label" style="color: #aaa;">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required minlength="6" style="background: #0d0d0d; border-color: #333; color: #fff;">
                            <div class="form-text" style="color: #888;">Password must be at least 6 characters long.</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label" style="color: #aaa;">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required style="background: #0d0d0d; border-color: #333; color: #fff;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #333;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="savePasswordBtn">Change Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Universal Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: #1a1a1a; color: #ffffff;">
                <div class="modal-header" style="border-bottom: 1px solid #333;">
                    <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage" style="color: #fff;">Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #333;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmModalBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Info Modal -->
    <div class="modal fade" id="transactionInfoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: #1a1a1a; color: #ffffff;">
                <div class="modal-header" style="border-bottom: 1px solid #333;">
                    <h5 class="modal-title">Transaction Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="color: #aaa;">Description:</label>
                        <p id="infoDescription" style="color: #fff; margin: 0;">-</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="color: #aaa;">Notes:</label>
                        <p id="infoNotes" style="color: #fff; margin: 0; white-space: pre-wrap;">-</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="color: #aaa;">Paid At:</label>
                        <p id="infoPaidAt" style="color: #fff; margin: 0;">-</p>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #333;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Method Selection Modal -->
    <div class="modal fade" id="paymentMethodModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #1a1a1a; color: #ffffff;">
                <div class="modal-header" style="border-bottom: 1px solid #333;">
                    <h5 class="modal-title">Select Payment Method</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p style="color: #ffffff;">How did you pay for this transaction?</p>
                    <div id="paymentMethodList" class="list-group">
                        <!-- Payment methods will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #333;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bank Comparison Modal -->
    <div class="modal fade" id="bankComparisonModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content" style="background: #1a1a1a; color: #ffffff;">
                <div class="modal-header" style="border-bottom: 1px solid #333;">
                    <h5 class="modal-title"><i class="fas fa-chart-line me-2"></i>Bank Rate Comparison</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 10px;">
                    <!-- Chart Controls -->
                    <div class="mb-3">
                        <div class="row g-2">
                            <div class="col-12">
                                <label class="form-label small mb-1" style="color: #aaa;">History Period:</label>
                                <select class="form-select form-select-sm" id="mobileBankComparisonMonths" style="background: #0d0d0d; border-color: #333; color: #fff;">
                                    <option value="1">1 Month</option>
                                    <option value="3" selected>3 Months</option>
                                    <option value="6">6 Months</option>
                                    <option value="12">1 Year</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="row g-2 mb-3" id="mobileBankSummaryCards">
                        <div class="col-6">
                            <div class="card" style="background: #2d2d2d; border: 1px solid #444;">
                                <div class="card-body p-2">
                                    <h6 class="text-muted mb-1 small">Best Buy Rate</h6>
                                    <h5 class="mb-0 text-success" id="mobileBestBuyRate">--</h5>
                                    <small class="text-muted" id="mobileBestBuyBank">--</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card" style="background: #2d2d2d; border: 1px solid #444;">
                                <div class="card-body p-2">
                                    <h6 class="text-muted mb-1 small">Current CBSL</h6>
                                    <h5 class="mb-0 text-primary" id="mobileCbslRate">--</h5>
                                    <small class="text-muted" id="mobileCbslDate">--</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="mobileBankComparisonLoading" class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3" style="color: #0d6efd;"></i>
                        <p style="color: #ccc;">Loading bank rates...</p>
                    </div>

                    <!-- Error State -->
                    <div id="mobileBankComparisonError" class="text-center py-5" style="display: none;">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3" style="color: #dc3545;"></i>
                        <p style="color: #ccc;" id="mobileBankComparisonErrorMsg">Failed to load bank comparison data.</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadMobileBankComparison()">
                            <i class="fas fa-sync-alt me-1"></i>Retry
                        </button>
                    </div>

                    <!-- Chart Container -->
                    <div id="mobileBankComparisonChartContainer" style="display: none;">
                        <div class="card" style="background: #2d2d2d; border: 1px solid #444;">
                            <div class="card-body p-2">
                                <h6 class="card-title mb-2 small" style="color: #fff;">
                                    <i class="fas fa-balance-scale me-1"></i>Buy Rate Comparison
                                </h6>
                                <div style="position: relative; height: 300px;">
                                    <canvas id="mobileBankComparisonChart"></canvas>
                                </div>
                                <!-- Legend -->
                                <div class="mt-2 small" id="mobileBankLegend" style="color: #aaa;">
                                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                                        <span><span style="display: inline-block; width: 12px; height: 3px; background: #0d6efd; margin-right: 4px;"></span>CBSL</span>
                                        <span><span style="display: inline-block; width: 12px; height: 3px; background: #198754; margin-right: 4px;"></span>HNB</span>
                                        <span><span style="display: inline-block; width: 12px; height: 3px; background: #fd7e14; margin-right: 4px;"></span>People's Bank</span>
                                        <span><span style="display: inline-block; width: 12px; height: 3px; background: #dc3545; margin-right: 4px;"></span>Sampath</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #333;">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="loadMobileBankComparison()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
    <script src="{{ url_for('static', filename='js/mobile.js') }}"></script>
</body>
</html>
